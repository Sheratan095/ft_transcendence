<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>API Test Page</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2rem; }
    input, button { margin: 0.5rem 0; }
    pre { background: #f0f0f0; padding: 1rem; }
  </style>
</head>
<body>

  <h1>Auth API Test</h1>

  <h2>Register</h2>
  <input type="text" id="reg-username" placeholder="Username">
  <input type="email" id="reg-email" placeholder="Email">
  <input type="password" id="reg-password" placeholder="Password">
  <button onclick="register()">Register</button>
  <pre id="reg-output"></pre>

  <h2>Login</h2>
  <input type="text" id="login-identifier" placeholder="Username or Email">
  <input type="password" id="login-password" placeholder="Password">
  <button onclick="login()">Login</button>
  <pre id="login-output"></pre>

  <h2>Refresh Token</h2>
  <input type="text" id="refresh-token" placeholder="Refresh Token">
  <button onclick="refreshToken()">Refresh</button>
  <pre id="refresh-output"></pre>

  <h2>Get Users (Protected)</h2>
  <input type="text" id="access-token" placeholder="Access Token">
  <button onclick="getUsers()">Get Users</button>
  <pre id="users-output"></pre>

<script>
const API_URL = 'http://localhost:3000/auth'; // Gateway is on port 3000

async function register() {
  const username = document.getElementById('reg-username').value;
  const email = document.getElementById('reg-email').value;
  const password = document.getElementById('reg-password').value;

  const res = await fetch(`${API_URL}/register`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username, email, password })
  });

  const data = await res.json();
  document.getElementById('reg-output').textContent = JSON.stringify(data, null, 2);
}

async function login() {
  const identifier = document.getElementById('login-identifier').value;
  const password = document.getElementById('login-password').value;

  const res = await fetch(`${API_URL}/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ username: identifier, password })
  });

  const data = await res.json();
  document.getElementById('login-output').textContent = JSON.stringify(data, null, 2);

  // Fill access & refresh token inputs for testing
  if(data.tokens){
    document.getElementById('access-token').value = data.tokens.accessToken;
    document.getElementById('refresh-token').value = data.tokens.refreshToken;
  }
}

async function refreshToken() {
  const refreshToken = document.getElementById('refresh-token').value;

  const res = await fetch(`${API_URL}/token`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ refreshToken })
  });

  const data = await res.json();
  document.getElementById('refresh-output').textContent = JSON.stringify(data, null, 2);

  if(data.tokens?.accessToken){
    document.getElementById('access-token').value = data.tokens.accessToken;
  }
}

async function getUsers() {
  const token = document.getElementById('access-token').value;

  const res = await fetch('http://localhost:3000/users/', {
    method: 'GET',
    headers: { 'Authorization': `Bearer ${token}` }
  });

  const data = await res.json();
  document.getElementById('users-output').textContent = JSON.stringify(data, null, 2);
}
</script>

</body>
</html>
