<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .message { margin: 5px 0; }
        .sent { color: blue; }
        .received { color: green; }
        .status { color: orange; }
        .error { color: red; }
        input { padding: 8px; margin: 5px; width: 300px; }
        button { padding: 8px 15px; margin: 5px; }
    </style>
</head>
<body>
    <h1>WebSocket Test Client</h1>
    
    <div>
        <input type="text" id="messageInput" placeholder="Enter message" />
        <button onclick="sendMessage()">Send Message</button>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>
    
    <div class="log" id="log">
        <div class="message status">Ready to connect...</div>
    </div>

    <script>
        let socket = null;
        const log = document.getElementById('log');
        const messageInput = document.getElementById('messageInput');

        function addLog(message, type = 'status') {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        function connect() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                addLog('Already connected!', 'status');
                return;
            }

            // Connect through the gateway which handles authentication
            socket = new WebSocket('ws://localhost:3000/notifications/ws');

            socket.addEventListener('open', () => {
                addLog('Connected to WebSocket server', 'status');
            });

            socket.addEventListener('message', (event) => {
                addLog(`Received: ${event.data}`, 'received');
            });

            socket.addEventListener('close', () => {
                addLog('Connection closed', 'status');
                socket = null;
            });

            socket.addEventListener('error', (error) => {
                addLog(`Error: ${error.message || 'Connection failed'}`, 'error');
            });
        }

        function disconnect() {
            if (socket) {
                socket.close();
            }
        }

        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) {
                addLog('Please enter a message', 'error');
                return;
            }

            if (!socket || socket.readyState !== WebSocket.OPEN) {
                addLog('Not connected! Click Connect first.', 'error');
                return;
            }

            socket.send(message);
            addLog(`Sent: ${message}`, 'sent');
            messageInput.value = '';
        }

        // Allow Enter key to send messages
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Auto-connect on page load
        window.addEventListener('load', connect);
    </script>
</body>
</html>