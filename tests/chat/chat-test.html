<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Service Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: #2d2d2d;
            padding: 15px 20px;
            border-bottom: 2px solid #3d3d3d;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .header h1 {
            font-size: 24px;
            color: #4CAF50;
            margin-bottom: 10px;
        }

        .login-panel {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .login-panel input {
            padding: 8px 12px;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .login-panel input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .btn {
            padding: 8px 16px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #45a049;
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #2196F3;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .btn-danger {
            background: #f44336;
        }

        .btn-danger:hover {
            background: #da190b;
        }

        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #2d2d2d;
            border-right: 2px solid #3d3d3d;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15px;
            background: #3d3d3d;
            border-bottom: 1px solid #4d4d4d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h3 {
            font-size: 16px;
            color: #4CAF50;
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            padding: 12px;
            background: #3d3d3d;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }

        .chat-item:hover {
            background: #4d4d4d;
        }

        .chat-item.active {
            background: #4d4d4d;
            border-left-color: #4CAF50;
        }

        .chat-item-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: #e0e0e0;
        }

        .chat-item-type {
            font-size: 12px;
            color: #aaa;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #252525;
        }

        .chat-header {
            padding: 15px 20px;
            background: #2d2d2d;
            border-bottom: 2px solid #3d3d3d;
        }

        .chat-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .chat-header h2 {
            font-size: 18px;
            color: #4CAF50;
        }

        .members-list {
            font-size: 12px;
            color: #aaa;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .member-badge {
            background: #3d3d3d;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            color: #e0e0e0;
            border: 1px solid #4d4d4d;
        }

        .member-badge.online {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .members-count {
            color: #666;
            font-style: italic;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            max-width: 70%;
            padding: 10px 14px;
            border-radius: 8px;
            word-wrap: break-word;
        }

        .message-sent {
            align-self: flex-end;
            background: #4CAF50;
            color: white;
        }

        .message-received {
            align-self: flex-start;
            background: #3d3d3d;
            color: #e0e0e0;
        }

        .message-private-sent {
            align-self: flex-end;
            background: #9C27B0;
            color: white;
            border-left: 4px solid #E1BEE7;
        }

        .message-private-received {
            align-self: flex-start;
            background: #4A148C;
            color: #E1BEE7;
            border-left: 4px solid #9C27B0;
        }

        .message-system {
            align-self: center;
            background: #2196F3;
            color: white;
            font-style: italic;
            font-size: 13px;
        }

        .message-system.user-join {
            background: #4CAF50;
        }

        .message-system.user-leave {
            background: #FF9800;
        }

        .message-header {
            font-size: 12px;
            margin-bottom: 4px;
            opacity: 0.8;
            font-weight: 600;
        }

        .message-content {
            font-size: 14px;
            line-height: 1.4;
        }

            .message-footer {
            font-size: 11px;
            margin-top: 4px;
            opacity: 0.7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .message-status {
            font-size: 11px;
            color: rgba(7, 7, 7, 0.9);
            font-weight: 500;
        }

        .message-private-badge {
            font-size: 10px;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 3px;
            margin-bottom: 4px;
            display: inline-block;
            font-weight: 600;
        }

        .input-container {
            padding: 15px 20px;
            background: #2d2d2d;
            border-top: 2px solid #3d3d3d;
            display: flex;
            gap: 10px;
        }

        .input-container input {
            flex: 1;
            padding: 10px 14px;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .input-container input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .status-bar {
            padding: 8px 20px;
            background: #1a1a1a;
            border-top: 1px solid #3d3d3d;
            font-size: 12px;
            color: #aaa;
            display: flex;
            justify-content: space-between;
        }

        .status-connected {
            color: #4CAF50;
        }

        .status-disconnected {
            color: #f44336;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #2d2d2d;
            padding: 25px;
            border-radius: 8px;
            min-width: 400px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .modal-content h3 {
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #3d3d3d;
            border: 1px solid #4d4d4d;
            border-radius: 4px;
            color: #e0e0e0;
            font-size: 14px;
        }

        .modal-content input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .placeholder {
            text-align: center;
            color: #666;
            padding: 40px;
            font-size: 16px;
        }

        .user-info {
            font-size: 12px;
            color: #aaa;
        }

        .user-info strong {
            color: #4CAF50;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #2d2d2d;
        }

        ::-webkit-scrollbar-thumb {
            background: #4d4d4d;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #5d5d5d;
        }

        .load-more-btn {
            align-self: center;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <!-- Header with login -->
    <div class="header">
        <h1>ðŸ’¬ Chat Service Test Client</h1>
        <div class="login-panel">
            <input type="email" id="emailInput" placeholder="Email" value="test1@gmail.com" />
            <input type="password" id="passwordInput" placeholder="Password" value="1234" />
            <button class="btn" id="loginBtn" onclick="login()">Login & Connect</button>
            <button class="btn btn-danger" id="logoutBtn" onclick="logout()" style="display: none;">Logout</button>
            <span class="user-info" id="userInfo"></span>
        </div>
    </div>

    <!-- Main container -->
    <div class="main-container">
        <!-- Sidebar with chat list -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>Chats</h3>
                <button class="btn btn-secondary" onclick="showCreateGroupModal()">+ Group</button>
            </div>
            <div class="chat-list" id="chatList">
                <div class="placeholder">Login to see your chats</div>
            </div>
        </div>

        <!-- Chat area -->
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-header-top">
                    <h2 id="chatTitle">Select a chat</h2>
                    <div>
                        <button class="btn btn-secondary" id="loadMoreBtn" onclick="loadMoreMessages()" style="display: none;">Load More</button>
                        <button class="btn btn-secondary" onclick="showPrivateMessageModal()">+ Private Message</button>
                        <button class="btn btn-secondary" id="addUserBtn" onclick="showAddUserModal()" style="display: none;">+ Add User</button>
                    </div>
                </div>
                <div class="members-list" id="membersList" style="display: none;">
                    <span class="members-count">Members:</span>
                </div>
            </div>
            <div class="messages-container" id="messagesContainer">
                <div class="placeholder">Select a chat to start messaging</div>
            </div>
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleMessageKeyPress(event)" disabled />
                <button class="btn" onclick="sendMessage()" id="sendBtn" disabled>Send</button>
            </div>
        </div>
    </div>

    <!-- Status bar -->
    <div class="status-bar">
        <span id="statusText">Disconnected</span>
        <span id="connectionCount">Online friends: 0</span>
    </div>

    <!-- Create Group Modal -->
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <h3>Create Group Chat</h3>
            <input type="text" id="groupNameInput" placeholder="Group name" />
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideCreateGroupModal()">Cancel</button>
                <button class="btn" onclick="createGroupChat()">Create</button>
            </div>
        </div>
    </div>

    <!-- Private Message Modal -->
    <div class="modal" id="privateMessageModal">
        <div class="modal-content">
            <h3>Send Private Message</h3>
            <input type="text" id="privateUserIdInput" placeholder="User ID" />
            <input type="text" id="privateMessageInput" placeholder="Message" />
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hidePrivateMessageModal()">Cancel</button>
                <button class="btn" onclick="sendPrivateMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal" id="addUserModal">
        <div class="modal-content">
            <h3>Add User to Group</h3>
            <input type="text" id="addUserIdInput" placeholder="User ID" />
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideAddUserModal()">Cancel</button>
                <button class="btn" onclick="addUserToChat()">Add User</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const GATEWAY_URL = 'https://localhost:3000';
        const WS_URL = 'wss://localhost:3000/chat/ws';
        const NOTIFICATION_WS_URL = 'wss://localhost:3000/notifications/ws';

        // State
        let ws = null;
        let notificationWs = null;
        let userId = null;
        let userEmail = null;
        let currentChatId = null;
        let chats = [];
        let messages = new Map(); // chatId -> messages array
        let chatMembers = new Map(); // chatId -> array of member objects {userId, username}
        let messageOffset = 0;
        const MESSAGE_LIMIT = 50;
        let pingInterval = null; // Store interval ID to prevent duplicates
        let notificationPingInterval = null;
        let pendingConfirmations = new Map(); // messageId -> status (store confirmations that arrive before the message)
        let onlineFriends = new Set(); // Track online friends

        // Login function
        async function login() {
            const email = document.getElementById('emailInput').value.trim();
            const password = document.getElementById('passwordInput').value;

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            try {
                updateStatus('Logging in...', false);

                const response = await fetch(`${GATEWAY_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include', // Important: include cookies in request
                    body: JSON.stringify({ email, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || response.statusText);
                }

                const data = await response.json();
                userId = String(data.user.id); // Ensure userId is always a string
                userEmail = data.user.email;

                console.log('Logged in - userId:', userId, 'type:', typeof userId);

                // HTTP-only cookies are automatically set by the browser
                // We don't need to manually extract or store them

                document.getElementById('userInfo').innerHTML = `Logged in as: <strong>${email}</strong> (ID: ${userId})`;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutBtn').style.display = 'inline-block';
                document.getElementById('emailInput').disabled = true;
                document.getElementById('passwordInput').disabled = true;

                // Load chats and connect WebSocket
                await loadChats();
                
                // Small delay to ensure cookies are properly set
                setTimeout(() => {
                    connectWebSocket();
                    connectNotificationWebSocket();
                }, 100);

            } catch (err) {
                console.error('Login error:', err);
                alert('Login failed: ' + err.message);
                updateStatus('Login failed', false);
            }
        }
        // Logout function
        function logout() {
            if (ws) {
                ws.close();
            }
            if (notificationWs) {
                notificationWs.close();
            }

            // Clear ping intervals
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }
            if (notificationPingInterval) {
                clearInterval(notificationPingInterval);
                notificationPingInterval = null;
            }

            ws = null;
            notificationWs = null;
            userId = null;
            userEmail = null;
            currentChatId = null;
            chats = [];
            messages.clear();
            chatMembers.clear();
            onlineFriends.clear();

            document.getElementById('userInfo').innerHTML = '';
            document.getElementById('loginBtn').style.display = 'inline-block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('emailInput').disabled = false;
            document.getElementById('passwordInput').disabled = false;
            document.getElementById('messageInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;

            document.getElementById('chatList').innerHTML = '<div class="placeholder">Login to see your chats</div>';
            document.getElementById('messagesContainer').innerHTML = '<div class="placeholder">Select a chat to start messaging</div>';
            document.getElementById('chatTitle').textContent = 'Select a chat';

            updateStatus('Disconnected', false);
        }

        // Load chats from API
        async function loadChats() {
            try {
                const response = await fetch(`${GATEWAY_URL}/chat/`, {
                    method: 'GET',
                    credentials: 'include' // Include HTTP-only cookies
                });

                if (!response.ok) {
                    throw new Error(`Failed to load chats: ${response.statusText}`);
                }

                chats = await response.json();
                
                // Store members for each chat
                chats.forEach(chat => {
                    if (chat.members) {
                        chatMembers.set(chat.id, chat.members);
                    }
                });
                
                renderChatList();

            } catch (err) {
                console.error('Error loading chats:', err);
                alert('Failed to load chats: ' + err.message);
            }
        }

        // Render chat list in sidebar
        function renderChatList() {
            const chatList = document.getElementById('chatList');

            if (chats.length === 0) {
                chatList.innerHTML = '<div class="placeholder">No chats yet</div>';
                return;
            }

            chatList.innerHTML = '';

            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                if (chat.id === currentChatId) {
                    chatItem.classList.add('active');
                }

                const chatName = chat.name || getChatDisplayName(chat);

                chatItem.innerHTML = `
                    <div class="chat-item-name">${chatName}</div>
                    <div class="chat-item-type">${chat.chatType === 'dm' ? 'Direct Message' : 'Group Chat'}</div>
                `;

                chatItem.onclick = () => selectChat(chat.id);
                chatList.appendChild(chatItem);
            });
        }

        // Get display name for a chat
        function getChatDisplayName(chat) {
            if (chat.chatType === 'dm') {
                // For DM, show the other user's name
                const otherMember = chat.members.find(m => m.userId !== userId);
                return otherMember ? otherMember.username : 'Unknown User';
            }
            return chat.name || 'Unnamed Group';
        }

        // Select a chat
        async function selectChat(chatId) {
            currentChatId = chatId;
            messageOffset = 0;
            renderChatList();

            const chat = chats.find(c => c.id === chatId);
            if (chat) {
                document.getElementById('chatTitle').textContent = getChatDisplayName(chat);
                
                // Show/hide add user button based on chat type
                const addUserBtn = document.getElementById('addUserBtn');
                if (chat.chatType === 'group') {
                    addUserBtn.style.display = 'inline-block';
                } else {
                    addUserBtn.style.display = 'none';
                }
                
                // Update members list
                updateMembersList(chatId);
            }

            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;

            await loadMessages(chatId);

            // Mark messages as read
            markChatAsRead(chatId);
        }

        // Load messages for a chat
        async function loadMessages(chatId, offset = 0) {
            try {
                const response = await fetch(`${GATEWAY_URL}/chat/messages?chatId=${chatId}&limit=${MESSAGE_LIMIT}&offset=${offset}`, {
                    method: 'GET',
                    credentials: 'include' // Include HTTP-only cookies
                });

                if (!response.ok) {
                    throw new Error(`Failed to load messages: ${response.statusText}`);
                }

                const newMessages = await response.json();
                
                console.log('Loaded messages from API:', newMessages);

                // Reverse to show oldest first (WhatsApp style)
                if (offset === 0) {
                    messages.set(chatId, newMessages.reverse());
                } else {
                    const existing = messages.get(chatId) || [];
                    messages.set(chatId, [...newMessages.reverse(), ...existing]);
                }

                renderMessages();

                // Show/hide load more button
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                if (newMessages.length === MESSAGE_LIMIT) {
                    loadMoreBtn.style.display = 'inline-block';
                } else {
                    loadMoreBtn.style.display = 'none';
                }

                // Scroll to bottom only on initial load
                if (offset === 0) {
                    scrollToBottom();
                }

            } catch (err) {
                console.error('Error loading messages:', err);
                alert('Failed to load messages: ' + err.message);
            }
        }

        // Load more messages
        async function loadMoreMessages() {
            if (!currentChatId) return;

            messageOffset += MESSAGE_LIMIT;
            await loadMessages(currentChatId, messageOffset);
        }

        // Render messages
        function renderMessages() {
            const container = document.getElementById('messagesContainer');

            if (!currentChatId) {
                container.innerHTML = '<div class="placeholder">Select a chat to start messaging</div>';
                return;
            }

            const chatMessages = messages.get(currentChatId) || [];

            if (chatMessages.length === 0) {
                container.innerHTML = '<div class="placeholder">No messages yet</div>';
                return;
            }

            container.innerHTML = '';

            chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                // Handle both snake_case (from API) and camelCase (from WebSocket)
                const senderId = msg.senderId || msg.sender_id;
                const createdAt = msg.createdAt || msg.created_at;
                const messageStatus = msg.messageStatus || msg.message_status;
                const isPrivate = msg.isPrivate || false;
                const isSystem = msg.isSystem || senderId === 'system' || senderId === null;
                
                // Handle system messages
                if (isSystem) {
                    messageDiv.className = 'message message-system';
                    messageDiv.innerHTML = `<div class="message-content">${escapeHtml(msg.content)}</div>`;
                    container.appendChild(messageDiv);
                    return;
                }
                
                // Compare as strings since backend returns string IDs
                const isSent = String(senderId) === String(userId);
                
                console.log('Message:', {senderId, userId, isSent, isPrivate, senderIdType: typeof senderId, userIdType: typeof userId});

                // Determine message class based on type and sender
                let messageClass = 'message ';
                if (isPrivate) {
                    messageClass += isSent ? 'message-private-sent' : 'message-private-received';
                } else {
                    messageClass += isSent ? 'message-sent' : 'message-received';
                }
                messageDiv.className = messageClass;

                let statusText = '';
                if (isSent && messageStatus) {
                    statusText = `<span class="message-status">${messageStatus}</span>`;
                }

                let privateBadge = '';
                if (isPrivate) {
                    privateBadge = '<div class="message-private-badge">ðŸ”’ Private Message</div>';
                }

                messageDiv.innerHTML = `
                    ${privateBadge}
                    ${!isSent ? `<div class="message-header">Sender: ${senderId}</div>` : ''}
                    <div class="message-content">${escapeHtml(msg.content)}</div>
                    <div class="message-footer">
                        <span>${new Date(createdAt).toLocaleTimeString()}</span>
                        ${statusText}
                    </div>
                `;

                container.appendChild(messageDiv);
            });
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content || !currentChatId) return;

            const chat = chats.find(c => c.id === currentChatId);
            if (!chat) return;

            if (ws && ws.readyState === WebSocket.OPEN) {
                let message;
                const tempId = 'temp-' + Date.now();
                
                // Use different event types based on chat type
                if (chat.chatType === 'dm') {
                    // For DM chats, send as private message to the other user
                    const otherMember = chat.members.find(m => String(m.userId) !== String(userId));
                    if (!otherMember) {
                        alert('Cannot find recipient in DM chat');
                        return;
                    }
                    
                    message = {
                        event: 'chat.privateMessage',
                        data: {
                            toUserId: String(otherMember.userId),
                            content: content
                        }
                    };
                } else {
                    // For group chats, send as chat message
                    message = {
                        event: 'chat.chatMessage',
                        data: {
                            chatId: currentChatId,
                            content: content
                        }
                    };
                }
                ws.send(JSON.stringify(message));
                input.value = '';
            } else {
                alert('WebSocket not connected');
            }
        }

        // Handle Enter key in message input
        function handleMessageKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Mark chat as read
        function markChatAsRead(chatId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    event: 'chat.read',
                    data: {
                        chatId: chatId
                    }
                };

                ws.send(JSON.stringify(message));
            }
        }

        // Connect to Notification WebSocket
        // Connect to Chat WebSocket
        function connectWebSocket() {
            if (ws) {
                ws.close();
            }

            // Clear any existing ping interval
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }

            updateStatus('Connecting...', false);

            // WebSocket connections automatically include cookies from the same domain
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('Chat WebSocket connected');
                updateConnectionStatus();
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (err) {
                    console.error('Error parsing chat WebSocket message:', err);
                }
            };

            ws.onclose = () => {
                console.log('Chat WebSocket closed');
                updateConnectionStatus();
                
                // Clear ping interval when connection closes
                if (pingInterval) {
                    clearInterval(pingInterval);
                    pingInterval = null;
                }
            };

            ws.onerror = (err) => {
                console.error('Chat WebSocket error:', err);
                console.error('Chat WebSocket readyState:', ws?.readyState);
                alert('Chat WebSocket connection failed. Check console for details.');
                updateConnectionStatus();
            };
        }
        // Handle Notification WebSocket messages
        function handleNotificationWebSocketMessage(message) {
            console.log('Received notification WebSocket message:', message);

            switch (message.event) {
                case 'friends.onlineList':
                    handleFriendsOnlineList(message.data);
                    break;

                case 'friend.online':
                    handleFriendOnline(message.data);
                    break;

                case 'friend.offline':
                    handleFriendOffline(message.data);
                    break;

                case 'friend.request':
                    handleFriendRequest(message.data);
                    break;

                case 'friend.accept':
                    handleFriendAccept(message.data);
                    break;

                case 'chat.userAdded':
                    handleChatUserAdded(message.data);
                    break;

                default:
                    console.log('Unknown notification event:', message.event);
            }
        }

        // Handle friends online list
        function handleFriendsOnlineList(data) {
            console.log('Friends online list received:', data);
            onlineFriends.clear();
            if (data.onlineFriends) {
                data.onlineFriends.forEach(friend => {
                    onlineFriends.add(friend.userId);
                });
            }
            showNotification('Friends Online', `${onlineFriends.size} friends are online`);
            updateFriendStatus();
        }

        // Handle friend coming online
        function handleFriendOnline(data) {
            console.log('Friend came online:', data);
            onlineFriends.add(data.userId);
            showNotification('Friend Online', `Friend ${data.userId} is now online`);
            updateFriendStatus();
        }

        // Handle friend going offline
        function handleFriendOffline(data) {
            console.log('Friend went offline:', data);
            onlineFriends.delete(data.userId);
            showNotification('Friend Offline', `Friend ${data.userId} went offline`);
            updateFriendStatus();
        }

        // Handle friend request
        function handleFriendRequest(data) {
            console.log('Friend request received:', data);
            showNotification('Friend Request', `${data.from} sent you a friend request`);
        }

        // Handle friend accept
        function handleFriendAccept(data) {
            console.log('Friend request accepted:', data);
            showNotification('Friend Request Accepted', `${data.from} accepted your friend request`);
        }

        // Handle chat user added
        function handleChatUserAdded(data) {
            console.log('User added to chat:', data);
            showNotification('Added to Chat', `${data.from} added you to a chat`);
            
            // Refresh chats to show the new chat
            loadChats().then(() => {
                console.log('Chats refreshed after being added to new chat');
            });
        }

        // Update friend status display
        function updateFriendStatus() {
            const connectionCount = document.getElementById('connectionCount');
            connectionCount.textContent = `Online friends: ${onlineFriends.size}`;
        }

        // Show notification
        function showNotification(title, message) {
            // Create a simple notification div
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4CAF50;
                color: white;
                padding: 12px 20px;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 300px;
                font-size: 14px;
            `;
            notification.innerHTML = `<strong>${title}</strong><br>${message}`;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }

        // Update connection status
        function updateConnectionStatus() {
            const chatConnected = ws && ws.readyState === WebSocket.OPEN;
            const notificationConnected = notificationWs && notificationWs.readyState === WebSocket.OPEN;
            
            let status = 'Disconnected';
            let isConnected = false;
            
            if (chatConnected && notificationConnected) {
                status = 'Connected (Chat + Notifications)';
                isConnected = true;
            } else if (chatConnected) {
                status = 'Connected (Chat only)';
                isConnected = true;
            } else if (notificationConnected) {
                status = 'Connected (Notifications only)';
                isConnected = true;
            }
            
            updateStatus(status, isConnected);
        }

        // Connect to Notification WebSocket
        function connectNotificationWebSocket() {
            if (notificationWs) {
                notificationWs.close();
            }

            // Clear any existing ping interval
            if (notificationPingInterval) {
                clearInterval(notificationPingInterval);
                notificationPingInterval = null;
            }

            console.log('Connecting to Notification WebSocket...');

            notificationWs = new WebSocket(NOTIFICATION_WS_URL);

            notificationWs.onopen = () => {
                console.log('Notification WebSocket connected');
                updateConnectionStatus();
            };

            notificationWs.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleNotificationWebSocketMessage(message);
                } catch (err) {
                    console.error('Error parsing Notification WebSocket message:', err);
                }
            };

            notificationWs.onclose = () => {
                console.log('Notification WebSocket closed');
                updateConnectionStatus();
                
                if (notificationPingInterval) {
                    clearInterval(notificationPingInterval);
                    notificationPingInterval = null;
                }
            };

            notificationWs.onerror = (err) => {
                console.error('Notification WebSocket error:', err);
                updateConnectionStatus();
            };
        }

        function connectWebSocket() {
            if (ws) {
                ws.close();
            }

            // Clear any existing ping interval
            if (pingInterval) {
                clearInterval(pingInterval);
                pingInterval = null;
            }

            updateStatus('Connecting...', false);

            // WebSocket connections automatically include cookies from the same domain
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WebSocket connected');
                updateStatus('Connected', true);
            };

            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (err) {
                    console.error('Error parsing WebSocket message:', err);
                }
            };

            ws.onclose = () => {
                console.log('WebSocket closed');
                updateStatus('Disconnected', false);
                
                // Clear ping interval when connection closes
                if (pingInterval) {
                    clearInterval(pingInterval);
                    pingInterval = null;
                }
            };

            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
                console.error('WebSocket readyState:', ws?.readyState);
                alert('WebSocket connection failed. Check console for details.');
                updateStatus('Connection error', false);
            };
        }
        // Handle WebSocket messages
        function handleWebSocketMessage(message) {
            console.log('Received chat WebSocket message:', message);
            console.log('Received WebSocket message:', message);

            switch (message.event) {
                case 'pong':
                    // Heartbeat response
                    break;

                case 'chat.message':
                    console.log('Handling chat.message event:', message.data);
                    handleIncomingMessage(message.data);
                    break;

                case 'chat.privateMessage':
                    console.log('Handling chat.privateMessage event:', message.data);
                    handleIncomingPrivateMessage(message.data);
                    break;

                case 'chat.userJoin':
                    handleSystemMessage(message.data);
                    break;

                case 'chat.userLeave':
                    handleSystemMessage(message.data);
                    break;

                case 'chat.messageSent':
                    handleMessageSent(message.data);
                    break;

                case 'chat.messageStatusUpdate':
                    handleMessageStatusUpdate(message.data);
                    break;

                case 'error':
                    console.error('Chat error:', message.data.message);
                    alert('Chat error: ' + message.data.message);
                    break;

                default:
                    console.log('Unknown message event:', message.event);
            }
        }

        // Handle incoming chat message
        function handleIncomingMessage(data) {
            console.log('handleIncomingMessage called with data:', data);
            const chatId = data.chatId;

            // Check if we have a pending confirmation for this message
            const pendingStatus = pendingConfirmations.get(data.messageId);
            if (pendingStatus) {
                console.log(`Found pending confirmation for message ${data.messageId}: ${pendingStatus}`);
                pendingConfirmations.delete(data.messageId);
            }

            // Create message object
            const msg = {
                id: data.messageId,
                chatId: chatId,
                senderId: data.senderId,
                content: data.content,
                createdAt: data.timestamp,
                messageStatus: pendingStatus || (String(data.senderId) === String(userId) ? 'delivered' : undefined),
                isPrivate: false
            };

            console.log('Adding message to UI:', msg);

            // Add to messages
            const chatMessages = messages.get(chatId) || [];
            chatMessages.push(msg);
            messages.set(chatId, chatMessages);

            // Re-render if this is the current chat
            if (chatId === currentChatId) {
                console.log('Rendering messages for current chat');
                renderMessages();
                scrollToBottom();

                // Mark as read
                markChatAsRead(chatId);
            } else {
                console.log(`Message is for chat ${chatId}, but current chat is ${currentChatId}`);
            }
        }

        // Handle incoming private message
        function handleIncomingPrivateMessage(data) {
            console.log('handleIncomingPrivateMessage called with data:', data);
            
            // Server now sends chatId, use it directly
            const chatId = data.chatId;
            if (!chatId) {
                console.error('No chatId received in private message!', data);
                return;
            }

            // Find or create chat for this private message
            let chat = chats.find(c => c.id === chatId);

            if (!chat) {
                console.log('Chat not found locally, creating DM chat with server chatId:', chatId);
                // Create a DM chat locally with the real server chatId
                chat = {
                    id: chatId,
                    name: null,
                    chatType: 'dm',
                    members: [
                        { userId: userId, username: 'You' },
                        { userId: data.senderId, username: data.from || `User ${data.senderId}` }
                    ],
                    createdAt: data.timestamp
                };
                chats.push(chat);
                renderChatList();
                console.log('Created new DM chat locally with real chatId:', chat);
            }

            if (chat) {
                console.log('Found chat:', chat.id);
                
                // Check if we have a pending confirmation for this message
                const pendingStatus = pendingConfirmations.get(data.messageId);
                if (pendingStatus) {
                    console.log(`Found pending confirmation for message ${data.messageId}: ${pendingStatus}`);
                    pendingConfirmations.delete(data.messageId);
                }

                const msg = {
                    id: data.messageId,
                    chatId: chat.id,
                    senderId: data.senderId,
                    content: data.content,
                    createdAt: data.timestamp,
                    messageStatus: pendingStatus,
                    isPrivate: false  // DM messages are regular messages, not "private" in UI
                };

                console.log('Adding private message to UI:', msg);

                const chatMessages = messages.get(chat.id) || [];
                chatMessages.push(msg);
                messages.set(chat.id, chatMessages);

                if (chat.id === currentChatId) {
                    renderMessages();
                    scrollToBottom();
                    markChatAsRead(chat.id);
                }
            }
        }

        // Handle system message
        function handleSystemMessage(data) {
            const chatId = data.chatId;

            const msg = {
                id: data.messageId || 'system-' + Date.now(),
                chatId: chatId,
                senderId: null, // Use null to match database format
                content: data.message,
                createdAt: data.timestamp,
                isSystem: true,
                systemType: data.type // userJoin, userLeave, etc.
            };

            const chatMessages = messages.get(chatId) || [];
            chatMessages.push(msg);
            messages.set(chatId, chatMessages);

            // Update member list if it's a user join/leave event
            if (data.type === 'userJoin' && data.targetId) {
                addMemberToChat(chatId, data.targetId, data.targetUsername);
            } else if (data.type === 'userLeave' && data.targetId) {
                removeMemberFromChat(chatId, data.targetId);
            }

            if (chatId === currentChatId) {
                renderMessages();
                scrollToBottom();
                updateMembersList(chatId);
            }
        }

        // Handle message sent confirmation
        function handleMessageSent(data) {
            const chatId = data.chatId;
            const messageId = data.messageId;
            const status = data.status;

            console.log(`Message ${messageId} sent with status: ${status}`, data);

            // Check if we know about this chat
            let chat = chats.find(c => c.id === chatId);
            if (!chat && data.chatType) {
                // New chat created - create it locally from the existing chatType in response
                console.log(`Chat ${chatId} not found locally, creating from chatType: ${data.chatType}`);
                
                // Create minimal chat object (usernames will be "User X" until properly loaded)
                chat = {
                    id: chatId,
                    name: data.chatType === 'dm' ? null : 'New Group',
                    chatType: data.chatType,
                    members: [], // Will be populated as messages arrive
                    createdAt: data.timestamp || new Date().toISOString()
                };
                
                chats.push(chat);
                renderChatList();
                console.log('Created new chat locally:', chat);
            }

            // Check if message already exists (from incoming message event)
            const chatMessages = messages.get(chatId) || [];
            const existingMsg = chatMessages.find(m => m.id === messageId);
            
            if (existingMsg) {
                // Update status if message already exists
                existingMsg.messageStatus = status;
                if (chatId === currentChatId) {
                    renderMessages();
                }
            } else {
                // Message doesn't exist yet - create it from the confirmation data
                console.log(`Creating message ${messageId} from confirmation`);
                
                const msg = {
                    id: messageId,
                    chatId: chatId,
                    senderId: userId,
                    content: data.content || data.message || '',
                    createdAt: data.timestamp || new Date().toISOString(),
                    messageStatus: status,
                    isPrivate: data.isPrivate || false
                };

                chatMessages.push(msg);
                messages.set(chatId, chatMessages);

                // Render if this is the current chat
                if (chatId === currentChatId) {
                    console.log('Rendering message for current chat');
                    renderMessages();
                    scrollToBottom();
                } else {
                    console.log(`Message is for chat ${chatId}, but current chat is ${currentChatId}`);
                }
            }
        }

        // Handle message status update
        function handleMessageStatusUpdate(data) {
            const chatId = data.chatId;
            const messageId = data.messageId;
            const status = data.overallStatus;

            console.log(`Message ${messageId} status updated to: ${status}`);

            // Update message status in UI
            const chatMessages = messages.get(chatId);
            if (chatMessages) {
                const msg = chatMessages.find(m => m.id === messageId);
                if (msg) {
                    msg.messageStatus = status;
                    if (chatId === currentChatId) {
                        renderMessages();
                    }
                }
            }
        }

        // Create group chat
        async function createGroupChat() {
            const groupName = document.getElementById('groupNameInput').value.trim();

            if (!groupName) {
                alert('Please enter a group name');
                return;
            }

            try {
                const response = await fetch(`${GATEWAY_URL}/chat/create-group-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Include HTTP-only cookies
                    body: JSON.stringify({ name: groupName })
                });

                if (!response.ok) {
                    throw new Error(`Failed to create group: ${response.statusText}`);
                }

                const newChat = await response.json();
                chats.push(newChat);
                renderChatList();

                hideCreateGroupModal();
                document.getElementById('groupNameInput').value = '';

                alert('Group chat created successfully!');

            } catch (err) {
                console.error('Error creating group:', err);
                alert('Failed to create group: ' + err.message);
            }
        }

        // Send private message
        function sendPrivateMessage() {
            const toUserId = document.getElementById('privateUserIdInput').value.trim();
            const content = document.getElementById('privateMessageInput').value.trim();

            if (!toUserId || !content) {
                alert('Please enter user ID and message');
                return;
            }

            if (ws && ws.readyState === WebSocket.OPEN) {
                const message = {
                    event: 'chat.privateMessage',
                    data: {
                        toUserId: toUserId,
                        content: content
                    }
                };

                ws.send(JSON.stringify(message));

                hidePrivateMessageModal();
                document.getElementById('privateUserIdInput').value = '';
                document.getElementById('privateMessageInput').value = '';

                // Note: chat list will be updated automatically when chat.messageSent arrives
                // with the new chat_id, which will trigger loadChats() only if needed

            } else {
                alert('WebSocket not connected');
            }
        }

        // Add user to chat
        async function addUserToChat() {
            const toUserId = document.getElementById('addUserIdInput').value.trim();

            if (!toUserId) {
                alert('Please enter a user ID');
                return;
            }

            if (!currentChatId) {
                alert('No chat selected');
                return;
            }

            try {
                const response = await fetch(`${GATEWAY_URL}/chat/add-user`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        chatId: currentChatId,
                        toUserId: toUserId
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to add user to chat');
                }

                alert('User added successfully!');
                hideAddUserModal();
                document.getElementById('addUserIdInput').value = '';

                // Reload chats to update member list
                await loadChats();

            } catch (err) {
                console.error('Error adding user to chat:', err);
                alert('Failed to add user: ' + err.message);
            }
        }

        // Modal functions
        function showCreateGroupModal() {
            document.getElementById('createGroupModal').classList.add('show');
        }

        function hideCreateGroupModal() {
            document.getElementById('createGroupModal').classList.remove('show');
        }

        function showPrivateMessageModal() {
            document.getElementById('privateMessageModal').classList.add('show');
        }

        function hidePrivateMessageModal() {
            document.getElementById('privateMessageModal').classList.remove('show');
        }

        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('show');
        }

        function hideAddUserModal() {
            document.getElementById('addUserModal').classList.remove('show');
        }

        // Utility functions
        function updateStatus(text, connected) {
            const statusText = document.getElementById('statusText');
            statusText.textContent = text;
            statusText.className = connected ? 'status-connected' : 'status-disconnected';
        }

        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update members list display
        function updateMembersList(chatId) {
            const membersList = document.getElementById('membersList');
            const members = chatMembers.get(chatId) || [];
            
            if (members.length === 0) {
                membersList.style.display = 'none';
                return;
            }
            
            membersList.style.display = 'flex';
            
            // Clear existing badges except the count label
            const badges = membersList.querySelectorAll('.member-badge');
            badges.forEach(badge => badge.remove());
            
            // Add member badges
            members.forEach(member => {
                const badge = document.createElement('span');
                badge.className = 'member-badge';
                if (onlineFriends.has(member.userId)) {
                    badge.classList.add('online');
                }
                badge.textContent = member.username || `User ${member.userId}`;
                badge.title = member.userId;
                membersList.appendChild(badge);
            });
        }

        // Add member to chat
        function addMemberToChat(chatId, userId, username) {
            const members = chatMembers.get(chatId) || [];
            if (!members.find(m => m.userId === userId)) {
                members.push({ userId, username });
                chatMembers.set(chatId, members);
                console.log(`Added member ${username} (${userId}) to chat ${chatId}`);
            }
        }

        // Remove member from chat
        function removeMemberFromChat(chatId, userId) {
            const members = chatMembers.get(chatId) || [];
            const filtered = members.filter(m => m.userId !== userId);
            chatMembers.set(chatId, filtered);
            console.log(`Removed member ${userId} from chat ${chatId}`);
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('show');
            }
        }
    </script>
</body>
</html>
