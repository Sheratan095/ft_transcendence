<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="style.css" rel="stylesheet">
</head>

<!-- no inner html
     -->
<body>
    <main id="app" hidden>
        <div class="turn">
            <h2 id="myTurn" hidden>it's your turn</h2>
            <h2 id="oppoTurn" hidden>it's opponent turn</h2>
        </div>
        <div id="board">
            <div class="row">
                <div class="cell" id="0"></div>
                <div class="cell" id="1"></div>
                <div class="cell" id="2"></div>
            </div>
            <div class="row">
                <div class="cell" id="3"></div>
                <div class="cell" id="4"></div>
                <div class="cell" id="5"></div>
            </div>
            <div class="row">
                <div class="cell" id="6"></div>
                <div class="cell" id="7"></div>
                <div class="cell" id="8"></div>
            </div>
        </div>
    </main>
    <button id="startBtn" class="button" disabled>Start</button>
    
    <script>
        const GATEWAY_URL = 'https://localhost:3000';
        let accessToken = null;
        let totalPlayer = 0;
        let totalIa = 0;
        let total = 0;
        let board = Array(3);
        board[0] = Array("empty", "empty", "empty");
        board[1] = Array("empty", "empty", "empty");
        board[2] = Array("empty", "empty", "empty");
        let score = 0;
        let i = 0;
        let iter = 0;

        function checkAdiacent(y, x, dir, score)
        {
            console.log("score: ", score);
            console.log("dir: ", dir);
            console.log("iteration: ", iter++);
            if (score === 2)
                return (1);
            // if (dir === 0)
            //     score--;
            // check left & right
            if (x + 1 < 3 && (dir === 0 || dir === 1))
            {
                if (board[y][x + 1] == 'X')
                {
                    //console.log("checking square: ", y, x);
                    //console.log(count);
                    console.log("found right");
                    score++;
                    if (checkAdiacent(y, x + 1, 1, score))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
                //return (0);
            }
            if (x - 1 <= 0 && (dir === 0 || dir === 2))
            {
                if (board[y][x - 1] == 'X')
                {
                    console.log("found left");
                    score++;
                    if (checkAdiacent(y, x - 1, 2, score))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
                //return (0);
            }
            // check under & over
            if (y + 1 < 3 && (dir === 0 || dir === 3))
            {
                if (board[y + 1][x] == 'X')
                {
                    console.log("found bottom");
                    score++;
                    if (checkAdiacent(y + 1, x, 3, score))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            if (y - 1 >= 0 && (dir === 0 || dir === 4))
            {
                if (board[y - 1][x] == 'X')
                {
                    console.log("found top");
                    score++;
                    if (checkAdiacent(y - 1, x, 4, score))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            // check diagonally 1
            if (y + 1 < 3 && x + 1 < 3 && (dir === 0 || dir === 5))
            {
                if (board[y + 1][x + 1] == 'X')
                {
                    score++;
                    if (checkAdiacent(y + 1, x + 1, 5, score))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            if (y - 1 >= 0 && x - 1 >= 0 && (dir === 0 || dir === 6))
            {
                if (board[y - 1][x - 1] == 'X')
                {
                    score++;
                    if (checkAdiacent(y - 1, x - 1, 6, score))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            // check diagonally 2
            if (y + 1 < 3 && x - 1 >= 0 && (dir === 0 || dir === 7))
            {
                if (board[y + 1][x - 1] == 'X')
                {
                    score++;
                    if (checkAdiacent(y + 1, x - 1, 7, score))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            if (y - 1 >= 0 && x + 1 < 3 && (dir === 0 || dir === 8))
            {
                if (board[y - 1][x + 1] == 'X')
                {
                    score++;
                    if (checkAdiacent(y - 1, x + 1, 8, score))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            return (0);
        }

        function checkWin()
        {
            // score = 3;
            console.log("new turn");
            for (let i = 0; i < 3; i++)
            {
                for (let j = 0; j < 3; j++)
                {
                    //console.log("y - x", i, j);
                    if (board[i][j] === 'X')
                    {
                        score = 0;
                        iter = 0;
                        //ret = checkAdiacent(i, j);
                        console.log("checking");
                        console.log("y - x", i, j);
                        if (checkAdiacent(i, j, 0, score))
                        {
                            console.log("player won");
                            return (1);
                        }
                        //console.log(checkAdiacent(i, j, 0, score));
                        //recursiveHelper(i, j);
                        //console.log(ret);
                    }
                }
            }
            // if (score >= 3)
            //     console.log("player win");
        }

        // remove a move from the board
        function removeFromBoard(index)
        {
            let value = index;
            let fixed = value;
            if (value === 0)
                fixed++;
            let x = value % 3;
            let y = Math.floor(fixed / 3);

            let valueStr = value.toString();
            board[y][x] = "empty";
            document.getElementById(valueStr).textContent = "";
            //console.log(board);
            console.log("removed index: ", index);
            console.log("y - x: ", y, x);
        }

        // change turn logic
        function nextTurn()
        {   
            //console.log("player won");            
            if (turn === 0)
            {
                myTurn.hidden = false;
                oppoTurn.hidden = true;
                if (totalPlayer >= 4)
                {
                    removeFromBoard(playerHistory[totalPlayer - 4]);
                }
                handlePlayerTurn();
            }
            else
            {
                oppoTurn.hidden = false;
                myTurn.hidden = true;
                totalIa++;
                if (totalIa >= 4)
                {
                    //removeFromBoard()
                    removeFromBoard(iaHistory[totalIa - 4]);
                    //console.log(iaHistory);
                }
                //console.log("totalIa: ", totalIa);
                handleIaTurn();
            }
            total++;
        }

        // handle player move
        function handlePlayerTurn(event)
        {
            //console.log("player turn");
            checkWin();
            totalPlayer++;
        }

        // handle ia move
        function handleIaTurn()
        {
            let value = getInt(8);
            let fixed = value;
            if (value === 0)
                fixed++;
            let x = value % 3;
            let y = Math.floor(fixed / 3);
            let z = 0;
            let holder = 0;

            if (board[y][x] === "X"
                || board[y][x] === "O")
            {
                let i = 0;
                let j = 0;
                let found = 0;
                while(i < 3)
                {
                    j = 0;
                    if (found)
                        break;
                    while(j < 3)
                    {
                        if (board[i][j] === 'empty')
                        {
                            y = i;
                            x = j;
                            value = z;
                            //console.log("invalid cell, new cell: ", i, j);
                            found = 1;
                        }
                        j++;
                        z++;
                    }
                    i++;
                }
            }
            let valueStr = value.toString();
            let cell = document.getElementById(valueStr).textContent = "O";
            iaHistory.push(value);
            turn = 0;
            board[y][x] = "O";
            //console.log(board);
            //console.log(iaHistory);
            nextTurn();
        }

        const playerHistory = [];
        const iaHistory = [];
    
        const email = "test1@gmail.com";
        const password = "1234";
        const startBtn = document.getElementById('startBtn');
        const appEl = document.getElementById('app');

        const myTurn = document.getElementById('myTurn');
        const oppoTurn = document.getElementById('oppoTurn');
        const table = document.getElementById('board');
        
        let turn;
        let finish = 0;
        let event;
        let val;

        // get random number
        function getInt(max)
        {   
            return Math.floor(Math.random() * max);
        }

        // moves listener
        table.addEventListener('click', async (event) => {
            let value = event.target.id;
            let fixed = value;
            if (value === 0)
                fixed++;
            let x = value % 3;
            let y = Math.floor(fixed / 3);
        
            //console.log("x - y : ", x, y);
            if (board[y][x] === "X"
                || board[y][x] === "O")
            {
                console.log(board);
                console.log("invalid cell");
                return;
            }
            let valueStr = value.toString();
            let cell = document.getElementById(valueStr).textContent = "X";
            playerHistory.push(value);
            turn = 1;
            board[y][x] = "X";
            nextTurn();
        });

        // login
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${GATEWAY_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Important for cookies
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Login successful:', data);
                    startBtn.disabled = false;
                } else {
                    console.error('Login failed with status:', response.status);
                    alert('Login failed');
                }
            } catch (err) {
                console.error('Login error:', err);
                alert('Error during login: ' + err.message);
            }
        });

        // game init
        startBtn.addEventListener('click', async () => {
            console.log('startBtn clicked');
            
            try {
                const response = await fetch(`${GATEWAY_URL}/tris/init`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include' // Important for cookies
                });
                

                //console.log('Init response status:', response.status);
                
                if (response.ok) {
                    //board = await response.json();
                    appEl.hidden = false;
                    turn = getInt(2);
                    nextTurn();
                }
                else
                {
                    console.error('Init failed with status:', response.status);
                    alert('Failed to initialize game');
                }
            } catch (err) {
                console.error('Error initializing game:', err);
                alert('Error: ' + err.message);
            }
        });
   
    </script>
    
</body>
</html>