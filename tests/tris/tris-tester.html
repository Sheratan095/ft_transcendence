<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <main id="app" hidden>
        <div class="turn">
            <h2 id="myTurn" hidden>it's your turn</h2>
            <h2 id="oppoTurn" hidden>it's opponent turn</h2>
            <h2 id="playerWin" hidden>you Won</h2>
            <h2 id="enemyWin" hidden>enemy Won</h2>
            <h2 id="iaTurn" hidden>opponent Won</h2>
        </div>
        <div id="board">
            <div class="row">
                <div class="cell" id="0"></div>
                <div class="cell" id="1"></div>
                <div class="cell" id="2"></div>
            </div>
            <div class="row">
                <div class="cell" id="3"></div>
                <div class="cell" id="4"></div>
                <div class="cell" id="5"></div>
            </div>
            <div class="row">
                <div class="cell" id="6"></div>
                <div class="cell" id="7"></div>
                <div class="cell" id="8"></div>
            </div>
        </div>
    </main>
    <button id="startBtn" class="button" disabled>Start</button>
    
    <script>
        const playerHistory = [];
        const iaHistory = [];
    
        const email = "test1@gmail.com";
        const password = "1234";
        const startBtn = document.getElementById('startBtn');
        const appEl = document.getElementById('app');

        const myTurn = document.getElementById('myTurn');
        const oppoTurn = document.getElementById('oppoTurn');
        const table = document.getElementById('board');
        const GATEWAY_URL = 'https://localhost:3000';
        const pWin = document.getElementById('playerWin');
        const eWin = document.getElementById('enemyWin');

        let endFlag = 0;
        let turn;
        let finish = 0;
        let event;
        let val;
        let accessToken = null;
        let totalPlayer = 0;
        let totalIa = 0;
        let total = 0;
        let board = Array(3);
        board[0] = Array("empty", "empty", "empty");
        board[1] = Array("empty", "empty", "empty");
        board[2] = Array("empty", "empty", "empty");
        let score = 0;
        let i = 0;
        let iter = 0;

        /**
         * function:
         *  recursively check for pairs in a given direction until score == 2
         * return:
         *  0 if the winning combination is not found, 1 if does
         * */
        function checkAdiacent(y, x, dir, score, charSym)
        {
            //  console.log("score: ", score);
            //  console.log("dir: ", dir);
            //  console.log("iteration: ", iter++);
            // console.log(charSym);
            if (score === 2)
                return (1);
            if (x + 1 < 3 && (dir === 0 || dir === 1))
            {
                if (board[y][x + 1] === charSym)
                {
                    // console.log("checking square: ", y, x);
                    // console.log(count);
                    // console.log("found right");
                    score++;
                    if (checkAdiacent(y, x + 1, 1, score, charSym))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
                //return (0);
            }
            if (x - 1 <= 0 && (dir === 0 || dir === 2))
            {
                if (board[y][x - 1] === charSym)
                {
                    //console.log("found left");
                    score++;
                    if (checkAdiacent(y, x - 1, 2, score, charSym))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
                //return (0);
            }
            // check under & over
            if (y + 1 < 3 && (dir === 0 || dir === 3))
            {
                if (board[y + 1][x] == charSym)
                {
                    // console.log("found bottom");
                    score++;
                    if (checkAdiacent(y + 1, x, 3, score, charSym))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            if (y - 1 >= 0 && (dir === 0 || dir === 4))
            {
                if (board[y - 1][x] === charSym)
                {
                    // console.log("found top");
                    score++;
                    if (checkAdiacent(y - 1, x, 4, score, charSym))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            // check diagonally down - right
            if (y + 1 < 3 && x + 1 < 3 && (dir === 0 || dir === 5))
            {
                //console.log("case down right");
                if (board[y + 1][x + 1] === charSym)
                {
                    score++;
                    if (checkAdiacent(y + 1, x + 1, 5, score, charSym))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            // check diagonally up - left
            if (y - 1 >= 0 && x - 1 >= 0 && (dir === 0 || dir === 6))
            {
                if (board[y - 1][x - 1] === charSym)
                {
                    score++;
                    if (checkAdiacent(y - 1, x - 1, 6, score, charSym))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            // check diagonally up - right
            if (y - 1 >= 0 && x + 1 < 3 && (dir === 0 || dir === 8))
            {
                //console.log("case diagonal2");
                if (board[y - 1][x + 1] == charSym)
                {
                    score++;
                    if (checkAdiacent(y - 1, x + 1, 8, score, charSym))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            // check diagonally down - left
            if (y + 1 < 3 && x - 1 >= 0 && (dir === 0 || dir === 7))
            {
                if (board[y + 1][x - 1] === charSym)
                {
                    //console.log("case diagonal");
                    score++;
                    if (checkAdiacent(y + 1, x - 1, 7, score, charSym))
                    {
                        return (1);
                    }
                    else
                    {
                        score = 0;
                    }
                }
            }
            return (0);
        }

        /**
         * function:
         *  calls a checkAdiacent on each cell of the board 
         * return:
         *  1 if the player won, 0 if not
         * */
        function checkWin(charSym)
        {
            // score = 3;
            //console.log("new turn");
            for (let i = 0; i < 3; i++)
            {
                for (let j = 0; j < 3; j++)
                {
                    //console.log("y - x", i, j);
                    if (board[i][j] === charSym)
                    {
                        score = 0;
                        iter = 0;
                        //  console.log("checking");
                        //  console.log("y - x", i, j);
                        if (checkAdiacent(i, j, 0, score, charSym))
                        {
                            if (charSym === 'X')
                            {
                                console.log("player won");
                                pWin.hidden = false;
                                endFlag = 1;
                            }
                            else
                            {
                                endFlag = 1;
                                console.log("enemyWon");
                                eWin.hidden = false;
                            }
                            return (1);
                        }
                    }
                }
            }
            return (0);
        }
        
        // function findBestMove()
        // {

        // }

        // function minMax()
        // {

        // }

        // remove a move from the board
        function removeFromBoard(index)
        {
            let value = index;
            let fixed = value;
            if (value === 0)
                fixed++;
            let x = value % 3;
            let y = Math.floor(fixed / 3);

            let valueStr = value.toString();
            board[y][x] = "empty";
            document.getElementById(valueStr).textContent = "";
            //console.log(board);
            console.log("removed index: ", index);
            console.log("y - x: ", y, x);
        }

        // change turn logic
        function nextTurn()
        {
            console.log("passing trough next turn");
            console.log(endFlag);
            if (endFlag)
            {
                console.log("exiting correctly");
                return (1);
            }
            // console.log(board);
            //console.log("player won");      
            if (turn === 0)
            {
                myTurn.hidden = false;
                //oppoTurn.hidden = true;
                if (handlePlayerTurn())
                {
                    console.log("shutting down");
                    console.log(endFlag);
                    return (1);
                }
            }
            else
            {
                oppoTurn.hidden = false;
                totalIa++;
                if (handleIaTurn())
                {
                    console.log("shutting down");
                    return (1);
                }
            }
            total++;
        }

        // handle player move
        function handlePlayerTurn(event)
        {
            if (totalPlayer >= 4)
            {
                removeFromBoard(playerHistory[totalPlayer - 4]);
            }
            //console.log("player turn");
            // if (checkWin('X'))
            // {
            //     console.log("passed trough player turn");
            //     return (1);
            // }
            totalPlayer++;
        }

        // handle ia move
        function handleIaTurn()
        {
            if (endFlag === 1)
            {
                console.log("game already ended, skipping");
                return (1);
            }
            let value = getInt(8);
            let fixed = value;
            if (value === 0)
                fixed++;
            let x = value % 3;
            let y = Math.floor(fixed / 3);
            let z = 0;
            let holder = 0;

            if (board[y][x] === "X"
                || board[y][x] === "O")
            {
                let i = 0;
                let j = 0;
                let found = 0;
                while(i < 3)
                {
                    j = 0;
                    if (found)
                        break;
                    while(j < 3)
                    {
                        if (board[i][j] === 'empty')
                        {
                            y = i;
                            x = j;
                            value = z;
                            //console.log("invalid cell, new cell: ", i, j);
                            found = 1;
                        }
                        j++;
                        z++;
                    }
                    i++;
                }
            }
            let valueStr = value.toString();
            let cell = document.getElementById(valueStr).textContent = "O";
            iaHistory.push(value);
            turn = 0;
            board[y][x] = "O";

            if (totalIa >= 4)
            {
                removeFromBoard(iaHistory[totalIa - 4]);
            }
            if (checkWin('O'))
            {
                console.log("exiting from IA move");
                endFlag = 1;
                return (1);
            }
            if (endFlag < 1)
                nextTurn();
            else
                console.log("skipping next turn");
        }

        // get random number
        function getInt(max)
        {   
            return Math.floor(Math.random() * max);
        }

        // moves listener
        table.addEventListener('click', async (event) =>
        {
            if (endFlag === 0)
            {
                let value = event.target.id;
                let fixed = value;
                if (value === 0)
                    fixed++;
                let x = value % 3;
                let y = Math.floor(fixed / 3);
            
                if (board[y][x] === "X"
                    || board[y][x] === "O")
                {
                    console.log(board);
                    console.log("invalid cell");
                    return;
                }
                let valueStr = value.toString();
                let cell = document.getElementById(valueStr).textContent = "X";
                playerHistory.push(value);
                turn = 1;
                board[y][x] = "X";

                if (checkWin('X'))
                {
                    console.log("ended in player move listener");
                    return (1);
                }
                
                if (endFlag < 1)
                {
                    console.log("calling next turn after a move");
                    if (nextTurn())
                    {
                        console.log("exiting from move listener");
                        return (1);
                    }
                }
                else
                {
                    console.log("game ended, skipping next turn");
                    return (1);
                }
            }
        });

        // game init
        startBtn.addEventListener('click', async () => {
            //console.log('startBtn clicked');
            try {
                const response = await fetch(`${GATEWAY_URL}/tris/init`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include' // Important for cookies
                });
                
                if (response.ok) {
                    appEl.hidden = false;
                    turn = getInt(2);
                    nextTurn();
                }
                else
                {
                    console.error('Init failed with status:', response.status);
                    alert('Failed to initialize game');
                }
            } catch (err) {
                console.error('Error initializing game:', err);
                alert('Error: ' + err.message);
            }
        });

        // login
        window.addEventListener('DOMContentLoaded', async () => {
            try {
            const response = await fetch(`${GATEWAY_URL}/auth/login`, {
                method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Important for cookies
                    body: JSON.stringify({ email, password })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Login successful:', data);
                    startBtn.disabled = false;
                } else {
                    console.error('Login failed with status:', response.status);
                    alert('Login failed');
                }
            } catch (err) {
                console.error('Login error:', err);
                alert('Error during login: ' + err.message);
            }
        });
   
    </script>
    
</body>
</html>